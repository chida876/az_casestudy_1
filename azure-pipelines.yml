trigger:
- main  # Replace with your branch name if needed

pool:
  name: Default  # Use the default self-hosted agent pool

steps:
# Step 1: Install Terraform (if not already installed on the self-hosted agent)
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'
    addToPath: true
- script: |
    curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
    apt update && apt install -y terraform
  displayName: 'Install Terraform'

# Step 2: Initialize Terraform
- script: |
    terraform init
  displayName: 'Terraform Init'

# Step 3: Plan Terraform
- script: |
    terraform plan -out=tfplan
  displayName: 'Terraform Plan'

# Step 4: Apply Terraform
- script: |
    terraform apply -auto-approve tfplan
  displayName: 'Terraform Apply'

# Optional: Destroy step (if needed for cleanup)
# Uncomment to include destroy functionality
# - script: |
#     terraform destroy -auto-approve
#   displayName: 'Terraform Destroy'
